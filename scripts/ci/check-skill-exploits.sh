#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
SKILLS_DIR="$ROOT_DIR/skills"

if [[ ! -d "$SKILLS_DIR" ]]; then
  echo "::error::skills directory not found at $SKILLS_DIR"
  exit 1
fi

shopt -s nullglob
skill_paths=("$SKILLS_DIR"/*)
if [[ ${#skill_paths[@]} -eq 0 ]]; then
  echo "::error::No skills found under $SKILLS_DIR"
  exit 1
fi

check_pattern() {
  local file="$1"
  local pattern="$2"
  local message="$3"

  if rg -n -P "$pattern" "$file" >/dev/null 2>&1; then
    echo "::error file=$file::$message"
    rg -n -P "$pattern" "$file" || true
    return 1
  fi
  return 0
}

for skill_path in "${skill_paths[@]}"; do
  [[ -d "$skill_path" ]] || continue
  skill_name="$(basename "$skill_path")"
  echo "Scanning markdown attack surface for: $skill_name"

  scan_targets=(
    "$skill_path/SKILL.md"
    "$skill_path/README.md"
  )

  for md_file in "${scan_targets[@]}"; do
    [[ -f "$md_file" ]] || continue
    check_pattern "$md_file" '<!--[^>]*ignore (all|previous) instructions' "Potential hidden prompt-injection text in HTML comment" || exit 1
    check_pattern "$md_file" '[A-Za-z0-9+/]{120,}={0,2}' "Suspicious long base64-like payload found" || exit 1
    check_pattern "$md_file" '[\x{200B}\x{200C}\x{200D}\x{FEFF}\x{202E}]' "Suspicious invisible or bidi Unicode character detected" || exit 1
    check_pattern "$md_file" '(?i)\bcurl\b[^\n]*https?://[^\n]*\|[^\n]*\b(sh|bash)\b|\bwget\b[^\n]*https?://[^\n]*\|[^\n]*\b(sh|bash)\b' "Pipe-to-shell command detected in markdown" || exit 1
  done
done

echo "Exploit-oriented markdown checks passed."
